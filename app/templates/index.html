<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Oil Rig Control Panel - Raspberry Pi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            rigDark: "#111827",
            rigYellow: "#facc15",
            rigOrange: "#f97316",
            rigRed: "#dc2626",
            rigGreen: "#16a34a"
          }
        }
      }
    }
  </script>
</head>

<body class="bg-rigDark text-gray-200 min-h-screen">

  <!-- HEADER -->
  <header class="bg-black shadow-lg border-b border-gray-700">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">

      <div class="flex items-center gap-8">
        <h1 class="text-2xl font-bold text-rigYellow">Oil Rig Monitoring System</h1>

        <a href="/user-guide"
           class="text-sm bg-gray-800 hover:bg-rigOrange hover:text-black
                  px-4 py-2 rounded-lg border border-gray-600 transition">
          User Guide
        </a>

                <a href="https://mqtt.pason.cohogs.com/"
           class="text-sm bg-gray-800 hover:bg-rigOrange hover:text-black
                  px-4 py-2 rounded-lg border border-gray-600 transition">
          RabbitMQTT
        </a>
      </div>

      <div class="flex items-center gap-6">
        <div id="wifiStatus" class="flex items-center gap-2">
          <span class="w-3 h-3 bg-rigGreen rounded-full"></span>
          <span class="text-sm">WiFi Connected</span>
        </div>
        <div id="serverStatus" class="flex items-center gap-2">
          <span class="w-3 h-3 bg-rigGreen rounded-full"></span>
          <span class="text-sm">Server Online</span>
        </div>
      </div>

    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="max-w-7xl mx-auto px-6 py-8">

    <!-- Sensors -->
    <h2 class="text-xl font-semibold mb-6 text-rigOrange">Sensor Readings (GPIO)</h2>

    <div class="grid md:grid-cols-3 gap-6">

      <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <h3 class="text-lg font-semibold mb-2">Well Pressure</h3>
        <p id="pressureValue" class="text-4xl font-bold text-rigYellow">1200 PSI</p>
        <p class="text-sm text-gray-400 mt-2">GPIO Pin 17</p>
      </div>

      <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <h3 class="text-lg font-semibold mb-2">Drill Temperature</h3>
        <p id="tempValue" class="text-4xl font-bold text-rigOrange">85°C</p>
        <p class="text-sm text-gray-400 mt-2">GPIO Pin 27</p>
      </div>

      <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
        <h3 class="text-lg font-semibold mb-2">Gas Level</h3>
        <p id="gasValue" class="text-4xl font-bold text-rigGreen">Safe</p>
        <p class="text-sm text-gray-400 mt-2">GPIO Pin 22</p>
      </div>

    </div>

    <!-- Controls -->
    <h2 class="text-xl font-semibold mt-12 mb-6 text-rigOrange">Control Systems (GPIO Outputs)</h2>

    <div class="grid md:grid-cols-3 gap-6">

      <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
        <h3 class="text-lg font-semibold mb-4">Blowout Preventer</h3>
        <button id="bopButton" onclick="toggleDevice('bop')"
          class="w-full bg-rigRed hover:bg-red-700 py-2 rounded-lg font-semibold">
          Toggle
        </button>
      </div>

      <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
        <h3 class="text-lg font-semibold mb-4">Mud Pump</h3>
        <button id="pumpButton" onclick="toggleDevice('pump')"
          class="w-full bg-rigYellow text-black hover:bg-yellow-400 py-2 rounded-lg font-semibold">
          Toggle
        </button>
      </div>

      <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
        <h3 class="text-lg font-semibold mb-4">Emergency Alarm</h3>
        <button id="alarmButton" onclick="toggleDevice('alarm')"
          class="w-full bg-rigOrange hover:bg-orange-600 py-2 rounded-lg font-semibold">
          Activate
        </button>
      </div>

    </div>

    <!-- Active Systems Section -->
    <section class="mt-12">
      <h2 class="text-xl font-semibold mb-4 text-rigOrange">Active Systems</h2>
      <div id="activeSystems" class="bg-gray-800 p-6 rounded-xl border border-gray-700 text-gray-300">
        Loading active systems...
      </div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer class="bg-black border-t border-gray-700 py-4 text-center text-sm text-gray-500">
    Raspberry Pi Oil Rig Control System | GPIO + WiFi Monitoring
  </footer>

  <!-- JAVASCRIPT -->
  <script>

    // Simulated sensor updates
    function updateSensors() {
      document.getElementById("pressureValue").innerText =
        (1100 + Math.floor(Math.random() * 200)) + " PSI";

      document.getElementById("tempValue").innerText =
        (80 + Math.floor(Math.random() * 15)) + "°C";

      const gasSafe = Math.random() > 0.2;
      const gasElement = document.getElementById("gasValue");

      gasElement.innerText = gasSafe ? "Safe" : "Danger";
      gasElement.className = gasSafe
        ? "text-4xl font-bold text-rigGreen"
        : "text-4xl font-bold text-rigRed";
    }

    setInterval(updateSensors, 5000);

    // Toggle device
    function toggleDevice(device) {
      let deviceName = { bop: "Blowout Preventer", pump: "Mud Pump", alarm: "Emergency Alarm" }[device];

      const confirmed = confirm(
        `CONFIRM ACTION\n\nYou are about to toggle: ${deviceName}\n\nEnsure this action is authorized and safe.\n\nPress OK to proceed or Cancel to abort.`
      );

      if (!confirmed) return;

      fetch(`/api/toggle/${device}`, { method: "POST" })
        .then(res => res.json())
        .then(data => {
          alert(`${deviceName} successfully toggled.`);
          console.log(device + " toggled:", data);

          // Update Emergency Alarm button text dynamically
          if (device === "alarm") {
            const alarmButton = document.getElementById("alarmButton");
            if (data.state) {
              alarmButton.innerText = "Deactivate";
            } else {
              alarmButton.innerText = "Activate";
            }
          }

          // Refresh active systems section immediately
          updateActiveSystems();
        })
        .catch(err => {
          alert("Error communicating with system.");
          console.error(err);
        });
    }

    // WiFi + Server status check
    function checkStatus() {
      fetch("/api/status")
        .then(res => res.json())
        .then(data => {
          const wifiDot = document.querySelector("#wifiStatus span");
          const serverDot = document.querySelector("#serverStatus span");

          wifiDot.className = data.wifi ? "w-3 h-3 bg-rigGreen rounded-full" : "w-3 h-3 bg-rigRed rounded-full";
          serverDot.className = data.server ? "w-3 h-3 bg-rigGreen rounded-full" : "w-3 h-3 bg-rigRed rounded-full";
        });
    }

    setInterval(checkStatus, 10000);

    // Active Systems Section
    function updateActiveSystems() {
      const devices = ["bop", "pump", "alarm"];
      const activeDiv = document.getElementById("activeSystems");

      fetch("/api/toggle-states")
        .then(res => res.json())
        .then(data => {
          const activeList = devices.filter(d => data[d]);
          if (activeList.length === 0) {
            activeDiv.innerHTML = "<span class='text-gray-400'>No systems are currently active.</span>";
          } else {
            activeDiv.innerHTML = activeList.map(d => {
              const names = { bop: "Blowout Preventer", pump: "Mud Pump", alarm: "Emergency Alarm" };
              const colors = { bop: "bg-rigRed", pump: "bg-rigYellow text-black", alarm: "bg-rigOrange" };
              return `<span class='inline-block ${colors[d]} px-3 py-1 rounded-full mr-2 mb-2'>${names[d]}</span>`;
            }).join("");
          }

          // Update alarm button text on page load
          const alarmButton = document.getElementById("alarmButton");
          if (data["alarm"]) {
            alarmButton.innerText = "Deactivate";
          } else {
            alarmButton.innerText = "Activate";
          }
        })
        .catch(err => {
          activeDiv.innerHTML = "<span class='text-red-500'>Error fetching active systems.</span>";
          console.error(err);
        });
    }

    setInterval(updateActiveSystems, 5000);
    updateActiveSystems();

  </script>

  <script src="https://swetrix.org/swetrix.js" defer></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    swetrix.init('OYrJOEkTAr4W', {
      apiURL: 'https://api.metrics.panel.ovcraft.com/log',
    })
    swetrix.trackViews()
  })
</script>

<noscript>
  <img
    src="https://api.metrics.panel.ovcraft.com/log/noscript?pid=OYrJOEkTAr4W"
    alt=""
    referrerpolicy="no-referrer-when-downgrade"
  />
</noscript>

</body>
</html>
